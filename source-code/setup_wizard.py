#!/usr/bin/env python3
"""
é…ç½®å‘å¯¼
å¸®åŠ©ç”¨æˆ·å¿«é€Ÿé…ç½®ç³»ç»Ÿ
"""

import os
import sys
import re

def print_colored(text, color_code=None):
    """æ‰“å°å½©è‰²æ–‡æœ¬"""
    colors = {
        'red': '\033[91m',
        'green': '\033[92m',
        'yellow': '\033[93m',
        'blue': '\033[94m',
        'purple': '\033[95m',
        'cyan': '\033[96m',
        'white': '\033[97m',
        'bold': '\033[1m',
        'end': '\033[0m'
    }
    
    if color_code and color_code in colors:
        print(f"{colors[color_code]}{text}{colors['end']}")
    else:
        print(text)

def read_env_file():
    """è¯»å–ç°æœ‰çš„.envæ–‡ä»¶"""
    env_vars = {}
    if os.path.exists('.env'):
        with open('.env', 'r', encoding='utf-8') as f:
            for line in f:
                line = line.strip()
                if line and not line.startswith('#') and '=' in line:
                    key, value = line.split('=', 1)
                    env_vars[key.strip()] = value.strip()
    return env_vars

def write_env_file(env_vars):
    """å†™å…¥.envæ–‡ä»¶"""
    with open('.env', 'w', encoding='utf-8') as f:
        f.write("# AI News Notification System Configuration\n")
        f.write("# Generated by setup wizard\n\n")
        
        f.write("# WeChat Work Robot Webhook URL\n")
        f.write(f"WECHAT_WEBHOOK_URL={env_vars.get('WECHAT_WEBHOOK_URL', 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_BOT_KEY')}\n\n")
        
        f.write("# Bilibili UPä¸» ID (æ©˜é¸¦Juya)\n")
        f.write(f"BILIBILI_UP_UID={env_vars.get('BILIBILI_UP_UID', '285286947')}\n\n")
        
        f.write("# Check interval in minutes\n")
        f.write(f"CHECK_INTERVAL={env_vars.get('CHECK_INTERVAL', '30')}\n\n")
        
        f.write("# Log level\n")
        f.write(f"LOG_LEVEL={env_vars.get('LOG_LEVEL', 'INFO')}\n")

def setup_wechat():
    """è®¾ç½®ä¼ä¸šå¾®ä¿¡é…ç½®"""
    print_colored("\nğŸ¤– ä¼ä¸šå¾®ä¿¡æœºå™¨äººé…ç½®", 'bold')
    print_colored("=" * 40, 'cyan')
    
    print("\nğŸ“‹ è·å–ä¼ä¸šå¾®ä¿¡æœºå™¨äººWebhook URLçš„æ­¥éª¤:")
    print("1. åœ¨ä¼ä¸šå¾®ä¿¡ä¸­æ‰“å¼€è¦æ¥æ”¶é€šçŸ¥çš„ç¾¤èŠ")
    print("2. ç‚¹å‡»ç¾¤èŠè®¾ç½® -> ç¾¤æœºå™¨äºº")
    print("3. ç‚¹å‡» 'æ·»åŠ æœºå™¨äºº'")
    print("4. é€‰æ‹© 'è‡ªå®šä¹‰æœºå™¨äºº'")
    print("5. è®¾ç½®æœºå™¨äººåç§°ï¼ˆå¦‚ï¼šAIæ—©æŠ¥é€šçŸ¥ï¼‰")
    print("6. å¤åˆ¶ç”Ÿæˆçš„ Webhook URL")
    
    print_colored("\nâš ï¸  é‡è¦æé†’:", 'yellow')
    print("- Webhook URLåŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œè¯·å‹¿æ³„éœ²")
    print("- URLæ ¼å¼åº”ä¸º: https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxxx")
    
    while True:
        webhook_url = input("\nè¯·è¾“å…¥ä¼ä¸šå¾®ä¿¡æœºå™¨äººçš„Webhook URL (å›è½¦è·³è¿‡): ").strip()
        
        if not webhook_url:
            print_colored("â­ï¸  è·³è¿‡ä¼ä¸šå¾®ä¿¡é…ç½®ï¼Œç¨åå¯åœ¨.envæ–‡ä»¶ä¸­æ‰‹åŠ¨é…ç½®", 'yellow')
            return None
        
        # éªŒè¯URLæ ¼å¼
        if not webhook_url.startswith('https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key='):
            print_colored("âŒ URLæ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥æ˜¯å¦ä¸ºå®Œæ•´çš„Webhook URL", 'red')
            continue
        
        if 'YOUR_BOT_KEY' in webhook_url or len(webhook_url) < 80:
            print_colored("âŒ è¯·ä½¿ç”¨å®é™…çš„Webhook URLï¼Œä¸è¦ä½¿ç”¨ç¤ºä¾‹åœ°å€", 'red')
            continue
        
        print_colored("âœ… URLæ ¼å¼æ­£ç¡®", 'green')
        return webhook_url

def setup_other_configs():
    """è®¾ç½®å…¶ä»–é…ç½®"""
    configs = {}
    
    print_colored("\nâš™ï¸  å…¶ä»–é…ç½®é€‰é¡¹", 'bold')
    print_colored("=" * 40, 'cyan')
    
    # æ£€æŸ¥é—´éš”
    print("\nâ° è®¾ç½®æ£€æŸ¥é—´éš”ï¼ˆå»ºè®®20-60åˆ†é’Ÿï¼‰:")
    while True:
        interval = input("æ£€æŸ¥é—´éš”ï¼ˆåˆ†é’Ÿï¼Œé»˜è®¤30ï¼‰: ").strip()
        if not interval:
            configs['CHECK_INTERVAL'] = '30'
            break
        try:
            interval_int = int(interval)
            if 5 <= interval_int <= 1440:  # 5åˆ†é’Ÿåˆ°24å°æ—¶
                configs['CHECK_INTERVAL'] = str(interval_int)
                break
            else:
                print_colored("âŒ è¯·è¾“å…¥5-1440ä¹‹é—´çš„æ•°å­—", 'red')
        except ValueError:
            print_colored("âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—", 'red')
    
    # æ—¥å¿—çº§åˆ«
    print("\nğŸ“ è®¾ç½®æ—¥å¿—çº§åˆ«:")
    print("1. DEBUG - è¯¦ç»†è°ƒè¯•ä¿¡æ¯")
    print("2. INFO - ä¸€èˆ¬ä¿¡æ¯ï¼ˆæ¨èï¼‰")
    print("3. WARNING - ä»…è­¦å‘Šå’Œé”™è¯¯")
    print("4. ERROR - ä»…é”™è¯¯ä¿¡æ¯")
    
    while True:
        level_choice = input("é€‰æ‹©æ—¥å¿—çº§åˆ«ï¼ˆ1-4ï¼Œé»˜è®¤2ï¼‰: ").strip()
        if not level_choice:
            level_choice = '2'
        
        level_map = {'1': 'DEBUG', '2': 'INFO', '3': 'WARNING', '4': 'ERROR'}
        if level_choice in level_map:
            configs['LOG_LEVEL'] = level_map[level_choice]
            break
        else:
            print_colored("âŒ è¯·è¾“å…¥1-4ä¹‹é—´çš„æ•°å­—", 'red')
    
    return configs

def test_configuration():
    """æµ‹è¯•é…ç½®"""
    print_colored("\nğŸ§ª æµ‹è¯•ç³»ç»Ÿé…ç½®", 'bold')
    print_colored("=" * 40, 'cyan')
    
    print("æ­£åœ¨è¿è¡Œç³»ç»Ÿæµ‹è¯•...")
    os.system("python3 test_system.py")

def main():
    """ä¸»é…ç½®å‘å¯¼"""
    print_colored("ğŸš€ AI News Notification System", 'bold')
    print_colored("é…ç½®å‘å¯¼", 'bold')
    print_colored("=" * 50, 'cyan')
    
    print("\næ¬¢è¿ä½¿ç”¨AIæ—©æŠ¥é€šçŸ¥ç³»ç»Ÿé…ç½®å‘å¯¼ï¼")
    print("è¿™ä¸ªå‘å¯¼å°†å¸®åŠ©æ‚¨å¿«é€Ÿé…ç½®ç³»ç»Ÿä»¥å¼€å§‹ä½¿ç”¨ã€‚")
    
    # è¯»å–ç°æœ‰é…ç½®
    env_vars = read_env_file()
    
    # è®¾ç½®ä¼ä¸šå¾®ä¿¡
    webhook_url = setup_wechat()
    if webhook_url:
        env_vars['WECHAT_WEBHOOK_URL'] = webhook_url
        print_colored("âœ… ä¼ä¸šå¾®ä¿¡é…ç½®å®Œæˆ", 'green')
    
    # è®¾ç½®å…¶ä»–é…ç½®
    other_configs = setup_other_configs()
    env_vars.update(other_configs)
    
    # è®¾ç½®é»˜è®¤å€¼
    env_vars.setdefault('BILIBILI_UP_UID', '285286947')
    
    # ä¿å­˜é…ç½®
    write_env_file(env_vars)
    print_colored("\nğŸ’¾ é…ç½®å·²ä¿å­˜åˆ° .env æ–‡ä»¶", 'green')
    
    # æ˜¾ç¤ºé…ç½®æ‘˜è¦
    print_colored("\nğŸ“‹ é…ç½®æ‘˜è¦:", 'bold')
    print_colored("-" * 30, 'cyan')
    wechat_status = "âœ… å·²é…ç½®" if webhook_url else "âŒ æœªé…ç½®"
    print(f"ä¼ä¸šå¾®ä¿¡æœºå™¨äºº: {wechat_status}")
    print(f"æ£€æŸ¥é—´éš”: {env_vars.get('CHECK_INTERVAL', '30')} åˆ†é’Ÿ")
    print(f"æ—¥å¿—çº§åˆ«: {env_vars.get('LOG_LEVEL', 'INFO')}")
    print(f"UPä¸»ID: {env_vars.get('BILIBILI_UP_UID', '285286947')} (æ©˜é¸¦Juya)")
    
    # è¯¢é—®æ˜¯å¦è¿è¡Œæµ‹è¯•
    print_colored("\nğŸ§ª é…ç½®å®Œæˆï¼", 'bold')
    test_choice = input("æ˜¯å¦ç«‹å³è¿è¡Œç³»ç»Ÿæµ‹è¯•ï¼Ÿ(y/nï¼Œé»˜è®¤y): ").strip().lower()
    if test_choice != 'n':
        test_configuration()
    
    # æ˜¾ç¤ºä¸‹ä¸€æ­¥
    print_colored("\nğŸ‰ é…ç½®å‘å¯¼å®Œæˆï¼", 'bold')
    print_colored("\nğŸ“ ä¸‹ä¸€æ­¥æ“ä½œ:", 'bold')
    if webhook_url:
        print("1. è¿è¡Œæµ‹è¯•: python3 main.py --mode test")
        print("2. æ­£å¼å¯åŠ¨: python3 main.py --mode run")
        print("3. æˆ–ä½¿ç”¨å¯åŠ¨è„šæœ¬: ./run.sh run")
    else:
        print("1. åœ¨ .env æ–‡ä»¶ä¸­é…ç½®ä¼ä¸šå¾®ä¿¡ Webhook URL")
        print("2. è¿è¡Œæµ‹è¯•: python3 main.py --mode test")
        print("3. æ­£å¼å¯åŠ¨: python3 main.py --mode run")
    
    print_colored("\nğŸ’¡ æç¤º: ä½¿ç”¨ './run.sh --help' æŸ¥çœ‹æ›´å¤šè¿è¡Œé€‰é¡¹", 'cyan')

if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        print_colored("\n\nğŸ‘‹ é…ç½®å‘å¯¼å·²å–æ¶ˆ", 'yellow')
        sys.exit(0)
    except Exception as e:
        print_colored(f"\nâŒ é…ç½®å‘å¯¼å‡ºç°é”™è¯¯: {e}", 'red')
        sys.exit(1)
